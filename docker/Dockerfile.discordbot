# FROM nvcr.io/nvidia/cuda:12.6.1-cudnn-devel-ubuntu22.04
FROM python:3.11-slim

RUN apt-get update && apt-get upgrade -yqq

RUN apt install libffi-dev libnacl-dev python3-dev -yqq

RUN pip install poetry==1.8.3
RUN poetry config virtualenvs.create false && poetry config cache-dir /poetry-cache

WORKDIR /crystalvision

COPY pyproject.toml poetry.lock poetry.toml ./
# RUN --mount=type=cache,target=/poetry-cache poetry install --compile

RUN pip install discord.py ollama

COPY crystalvision ./

ENV DISCORD_TOKEN=${DISCORD_TOKEN}
ENV OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL}
ENV OLLAMA_CHAT_MODEL=${OLLAMA_CHAT_MODEL}

ENTRYPOINT [ "python", "discordbot.py" ]
